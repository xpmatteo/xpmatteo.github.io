<!DOCTYPE html>
<html>


<!-- Mirrored from matteo.vaccari.name/blog/archives/650 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 24 Sep 2021 09:57:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="initial-scale=1">

<title>Extreme Enthusiasm  &raquo; Blog Archive   &raquo; Fixing session management in Tomcat </title>

<meta name="generator" content="WordPress 5.1.1" /> <!-- leave this for stats -->

<link rel="stylesheet" href="../wp-content/themes/mv2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Extreme Enthusiasm RSS Feed" href="../feed" />
<link rel="pingback" href="../xmlrpc.php" />

<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="Extreme Enthusiasm &raquo; Fixing session management in Tomcat Comments Feed" href="650/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/matteo.vaccari.name\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.1.1"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='../wp-includes/css/dist/block-library/style.min3c21.css?ver=5.1.1' type='text/css' media='all' />
<link rel='https://api.w.org/' href='../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='On knowing what you&#8217;re doing' href='645.html' />
<link rel='next' title='Sulla sessione &#8220;Is Software Evolution Really Effective&#8221; di Francesco Cirillo' href='664.html' />
<meta name="generator" content="WordPress 5.1.1" />
<link rel="canonical" href="650.html" />
<link rel='shortlink' href='../indexf034.html?p=650' />
<link rel="alternate" type="application/json+oembed" href="../wp-json/oembed/1.0/embede4a7.json?url=http%3A%2F%2Fmatteo.vaccari.name%2Fblog%2Farchives%2F650" />
<link rel="alternate" type="text/xml+oembed" href="../wp-json/oembed/1.0/embed3788?url=http%3A%2F%2Fmatteo.vaccari.name%2Fblog%2Farchives%2F650&amp;format=xml" />
</head>
<body>
<div id="page">

<div id="header">
	<h1><a href="../../blog">Extreme Enthusiasm</a></h1>
</div>

<div id='maincontent'>
    <div id='main-col'>

  
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="645.html" rel="prev">On knowing what you&#8217;re doing</a></div>
			<div class="alignright"><a href="664.html" rel="next">Sulla sessione &#8220;Is Software Evolution Really Effective&#8221; di Francesco Cirillo</a> &raquo;</div>
		</div>

		<div class="post" id="post-650">
			<h2><a href="650.html" rel="bookmark" title="Permanent Link: Fixing session management in Tomcat">Fixing session management in Tomcat</a></h2>

			<div class="entrytext">
				<blockquote><p>
  Sessions are the Achilles heel of every application server.<br />
  <cite>Michael T. Nygard, <a href="http://pragprog.com/book/mnee/release-it">Trampled By Your Own Customers</a> (<a href="http://media.pragprog.com/titles/mnee/mnee-story2.pdf">pdf</a>)</cite>
</p></blockquote>
<p>Earlier this year I started a big Java development project with my team.  I did mostly Rails development for a long time, so when I came back to  Web applications in Java I had some expectations.  I expected that Tomcat would treat user sessions in much the same way as Rails does; but it doesn&#8217;t.</p>
<p><span id="more-650"></span></p>
<p>A bit of background.  In a RESTful web application, all session data is maintained in the memory of clients, and nothing at all is saved in server-side sessions.  In a well-written web application you might want to save just a few bytes on the server; ideally you should save no more than the id of the authenticated user.  On the other hand, poorly-written application and frameworks tend to save lots of data in server-side sessions.</p>
<p>In a Rails application, there are essentially three ways to implement session data:</p>
<p>a) in encrypted cookies, which are entirely client-side;</p>
<p>b) in server-side files;</p>
<p>c) in a database table.</p>
<p>In a single-server application you might want to use a) for maximum efficiency, or b) to avoid the risk of someone tampering the cookies (not easy to do; it is necessary to steal the encryption key.)  In a multi-server application you might choose a) for maximum efficiency, or c) for added security.</p>
<p>Now let me clarify this: servers-side sessions in a database table are extremely efficient.  Most web applications make dozens of database queries per page view; adding one or two simple queries for getting the session data will *not* add a significant overhead.  </p>
<p>This was my point of view when I came from Rails to Java again.  Now we are writing an application that will run on Tomcat, and I was expecting that Tomcat, being an established product, would offer similar functionality; but it does not.</p>
<p><center><br />
    *<br />
  *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br />
</center></p>
<h3>Tomcat options</h3>
<p>When it comes to session management, Tomcat offers three options:</p>
<p>i) The standard session manager, that keeps sessions in the Java heap.</p>
<p>ii) The &#8220;persistent&#8221; session manager, that keeps sessions in the Java heap and  and might swap &#8220;inactive&#8221; sessions on file or on a database.</p>
<p>iii) The &#8220;clustering&#8221; session manager, that keeps sessions in the Java heap and keeps them synchronized with other instances of Tomcat using a custom protocol over TCP.  In order to cater for the needs of poorly-written applications that save lots of data in sessions, this manager has a sophisticated algorithm for moving &#8220;deltas&#8221; of session data instead of moving full session contents.</p>
<p>At first I thought that I could use option ii) to replicate the functionality of Rails option c).  But <a href="http://www.reinwaldwarapen.com/2011/01/storing-and-sharing-sessions-among.html" title="Inside the mind of Reinwald Warapen: Storing and Sharing Sessions among standalone Tomcat instances">it turns out that it&#8217;s not possible</a>; the &#8220;persistent&#8221; session manager insists that sessions are saved to disk in batches, not individually.  This means that there is no guarantee that users will not lose their session, if they click quickly from a page to another.</p>
<p>I briefly considered option iii), but it requires to open new TCP ports.  For my application, this would require complex firewall adjustments, since our servers are located in different geographic locations.  I would feel like a stupid to ask people in Operations to open this many holes in their firewalls.  And I would not bet a dime on the security implications.  Besides, the whole concept seems a hugely complicated way to do stuff that is best left to specialized services like memcached.  The fact that the whole thing is optimized for poorly-written applications makes me like it even less.</p>
<p>In addition, all three options store session data in the Java heap.  This is an incredibly bad idea.  Memory is the most important resource for a Java application.  You don&#8217;t want to waste Java heap memory for session data that will be used at best once every few minutes, and at worst will never be needed again.  Doing this means that memory usage will grow linearly with the number of sessions, and most of that memory will be unused for most of the time.  As a consequence, we will be forced to set a maximum number of concurrent users.  </p>
<p>A RESTful application, on the other hand, will not waste memory on sessions, so its memory consumption will depend on the number of concurrent *accesses*, not sessions.  The application only allocates the memory it needs to fulfill the requests it is currently serving, and <em>no more</em>.  As a result, a RESTful application can handle many more concurrent requests, all other things being equal.</p>
<p>I can imagine that the reasoning behind the Tomcat session managers is that keeping sessions in memory is &#8220;more efficient&#8221;.  For most common applications, this reasoning is wrong.  For a scalable (and robust) application, the efficiency that matters most is memory efficiency; adding a few milliseconds of latency per request does not matter.  Tomcat reminds me of what <a href="https://www.varnish-cache.org/trac/wiki/ArchitectNotes">this very good article</a> calls &#8220;1975 programming&#8221;; adding complications when the simpler algorithm would be much better.</p>
<h3>Conclusion</h3>
<p>In conclusion, how do I think I will solve the problem with Tomcat?  I could write my own session manager; but that requires to interact with complex interfaces that I&#8217;m not confident to be able to understand correctly in a short time.  I could use one of the several alternative session managers that are based on <a href="http://code.google.com/p/memcached-session-manager/" title="Tomcat high-availability clusters with memcached">alternative</a> <a href="http://jbrisbin.com/web2/articles/tomcat-session-manager-backed-by-riak/" title="Tomcat Session Manager backed by Riak | jbrisbin.com">stores</a>; but I don&#8217;t really need to save milliseconds on latency, and I don&#8217;t want to install new services, and what&#8217;s more important I don&#8217;t know how reliable these things are.</p>
<p>The solution I decided to use is to roll my own session management in the application.  I will apply to all requests a filter that does the following:</p>
<ol>
<li>Look for a session cookie.  If it&#8217;s missing, redirect to the authentication page; otherwise find the session id in the cookie and use it to fetch session data from the database.</li>
<li>If the session data is not found or if it&#8217;s expired, then redirect to the authentication page.</li>
<li>Otherwise find the id of the authenticated user in the session.</li>
</ol>
<p>The authentication page asks the user for credentials; if they are correct, then it</p>
<ol>
<li>Generates a session id using a secure random number generator;</li>
<li>save the session id in a cookie;</li>
<li>save the user id in the database.</li>
</ol>
<p>It&#8217;s simple and very efficient.  There&#8217;s not much more needed.  This scheme has a nice property: it only creates a session for users who supplied valid credentials.  This avoids the problem of <a href="http://pragprog.com/book/mnee/release-it">generating lots of useless sessions for requests coming from search engines</a>.  It&#8217;s also more secure, because it makes it much more difficult for a sophisticated attacker to guess existing session numbers.  This is better than what most application servers do :-)</p>
<p>Another nice property is that session data never changes.  The only thing we store in it is the user id, and there is no way or reason for it to change.</p>

				
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on 26 October 2011 at 23:03						and is filed under <a href="category/agile.html" rel="category tag">Agile</a>.
						You can follow any responses to this entry through the <a href="650/feed">RSS 2.0</a> feed.

													You can <a href="#respond">leave a response</a>, or <a href="650/trackback" rel="trackback">trackback</a> from your own site.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->

	<h3 id="comments">2 Responses to &#8220;Fixing session management in Tomcat&#8221;</h3> 

	<ol class="commentlist">

	
		<li class="alt" id="comment-94533">
			<cite>Uberto</cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-94533" title="">November 24th, 2011 at 10:42</a> </small>

			<p>That&#8217;s the same we did but for different reasons. In our Restful app we need to store the just user credentials in the session (it works both in cookies or as parameter), we want the sessionId to stay on the db for security logs (there is a batch to delete them after some months) and to avoid the (mis-)use of Java Session as a generic bucket.</p>

		</li>

	
	
		<li class="" id="comment-94998">
			<cite>Luk</cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-94998" title="">March 30th, 2012 at 13:45</a> </small>

			<p>Don&#8217;t forget that you may expose your site to hacking with this DIY approach.</p>

		</li>

	
	
	</ol>

 


<h3 id="respond">Leave a Reply</h3>


<form action="http://matteo.vaccari.name/blog/wp-comments-post.php" method="post" id="commentform">


<p><input type="text" name="author" id="author" value="" size="22" tabindex="1" />
<label for="author"><small>Name (required)</small></label></p>

<p><input type="text" name="email" id="email" value="" size="22" tabindex="2" />
<label for="email"><small>Mail (will not be published) (required)</small></label></p>

<p><input type="text" name="url" id="url" value="" size="22" tabindex="3" />
<label for="url"><small>Website</small></label></p>


<!--<p><small><strong>XHTML:</strong> You can use these tags: &lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;s&gt; &lt;strike&gt; &lt;strong&gt; </small></p>-->

<p><textarea name="comment" id="comment" cols="100%" rows="10" tabindex="4"></textarea></p>

<p><input name="submit" type="submit" id="submit" tabindex="5" value="Submit Comment" />
<input type="hidden" name="comment_post_ID" value="650" />
</p>
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="e5efa924b9" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="23"/></p>
</form>



	
    </div>

    <div id='right-col'>
        <div id="sidebar">
    <ul>

      <li>
        <form method="get" id="searchform" action="http://matteo.vaccari.name/blog/">
  <div>
    <input tabindex="1" type="text" value="" name="s" id="s" />
    <input type="submit" id="searchsubmit" value="Search" />
  </div>
</form>
      </li>

      <li>

        <h2>About</h2>

	I am a software developer working with <a href="http://thoughtworks.com/">Thoughtworks Italia</a>.
        I'm a fan of <a
        href="http://extremeprogramming.org/">Extreme Programming</a>.
        I&nbsp;helped organize the <a
        href="http://essap.dicom.uninsubria.it/">European Summer School on
        Agile Programming</a>

      </li>

      <li>
            </li>

      <li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-851"><a href="../selected-tdd-resources-to-start.html">Selected TDD Resources To Start</a></li>
<li class="page_item page-item-583"><a href="../tdd-resources.html">TDD Resources</a></li>
<li class="page_item page-item-247"><a href="../the-hexagonal-architecture.html">The Hexagonal Architecture</a></li>
</ul></li>

      
      <li><h2>Archives</h2>
        <ul>
        	<li><a href='date/2018/10.html'>October 2018</a></li>
	<li><a href='date/2017/09.html'>September 2017</a></li>
	<li><a href='date/2016/08.html'>August 2016</a></li>
	<li><a href='date/2016/03.html'>March 2016</a></li>
	<li><a href='date/2016/01.html'>January 2016</a></li>
	<li><a href='date/2014/12.html'>December 2014</a></li>
	<li><a href='date/2014/10.html'>October 2014</a></li>
	<li><a href='date/2014/06.html'>June 2014</a></li>
	<li><a href='date/2014/02.html'>February 2014</a></li>
	<li><a href='date/2013/12.html'>December 2013</a></li>
	<li><a href='date/2013/11.html'>November 2013</a></li>
	<li><a href='date/2013/06.html'>June 2013</a></li>
	<li><a href='date/2013/05.html'>May 2013</a></li>
	<li><a href='date/2013/03.html'>March 2013</a></li>
	<li><a href='date/2013/02.html'>February 2013</a></li>
	<li><a href='date/2012/10.html'>October 2012</a></li>
	<li><a href='date/2012/08.html'>August 2012</a></li>
	<li><a href='date/2012/07.html'>July 2012</a></li>
	<li><a href='date/2012/06.html'>June 2012</a></li>
	<li><a href='date/2012/05.html'>May 2012</a></li>
	<li><a href='date/2012/04.html'>April 2012</a></li>
	<li><a href='date/2012/01.html'>January 2012</a></li>
	<li><a href='date/2011/12.html'>December 2011</a></li>
	<li><a href='date/2011/11.html'>November 2011</a></li>
	<li><a href='date/2011/10.html'>October 2011</a></li>
	<li><a href='date/2011/07.html'>July 2011</a></li>
	<li><a href='date/2011/06.html'>June 2011</a></li>
	<li><a href='date/2011/05.html'>May 2011</a></li>
	<li><a href='date/2011/04.html'>April 2011</a></li>
	<li><a href='date/2011/03.html'>March 2011</a></li>
	<li><a href='date/2011/02.html'>February 2011</a></li>
	<li><a href='date/2010/11.html'>November 2010</a></li>
	<li><a href='date/2010/10.html'>October 2010</a></li>
	<li><a href='date/2010/09.html'>September 2010</a></li>
	<li><a href='date/2010/08.html'>August 2010</a></li>
	<li><a href='date/2010/07.html'>July 2010</a></li>
	<li><a href='date/2010/06.html'>June 2010</a></li>
	<li><a href='date/2010/05.html'>May 2010</a></li>
	<li><a href='date/2010/04.html'>April 2010</a></li>
	<li><a href='date/2010/03.html'>March 2010</a></li>
	<li><a href='date/2010/02.html'>February 2010</a></li>
	<li><a href='date/2010/01.html'>January 2010</a></li>
	<li><a href='date/2009/12.html'>December 2009</a></li>
	<li><a href='date/2009/11.html'>November 2009</a></li>
	<li><a href='date/2009/10.html'>October 2009</a></li>
	<li><a href='date/2009/09.html'>September 2009</a></li>
	<li><a href='date/2009/07.html'>July 2009</a></li>
	<li><a href='date/2009/05.html'>May 2009</a></li>
	<li><a href='date/2009/04.html'>April 2009</a></li>
	<li><a href='date/2009/03.html'>March 2009</a></li>
	<li><a href='date/2009/02.html'>February 2009</a></li>
	<li><a href='date/2009/01.html'>January 2009</a></li>
	<li><a href='date/2008/12.html'>December 2008</a></li>
	<li><a href='date/2008/11.html'>November 2008</a></li>
	<li><a href='date/2008/10.html'>October 2008</a></li>
	<li><a href='date/2008/09.html'>September 2008</a></li>
	<li><a href='date/2008/07.html'>July 2008</a></li>
	<li><a href='date/2008/06.html'>June 2008</a></li>
	<li><a href='date/2008/05.html'>May 2008</a></li>
	<li><a href='date/2008/04.html'>April 2008</a></li>
	<li><a href='date/2008/01.html'>January 2008</a></li>
	<li><a href='date/2007/11.html'>November 2007</a></li>
	<li><a href='date/2007/10.html'>October 2007</a></li>
	<li><a href='date/2007/09.html'>September 2007</a></li>
	<li><a href='date/2007/06.html'>June 2007</a></li>
	<li><a href='date/2007/05.html'>May 2007</a></li>
	<li><a href='date/2007/04.html'>April 2007</a></li>
	<li><a href='date/2007/03.html'>March 2007</a></li>
	<li><a href='date/2007/02.html'>February 2007</a></li>
	<li><a href='date/2007/01.html'>January 2007</a></li>
	<li><a href='date/2006/12.html'>December 2006</a></li>
	<li><a href='date/2006/11.html'>November 2006</a></li>
	<li><a href='date/2006/10.html'>October 2006</a></li>
	<li><a href='date/2006/09.html'>September 2006</a></li>
	<li><a href='date/2006/08.html'>August 2006</a></li>
	<li><a href='date/2006/07.html'>July 2006</a></li>
	<li><a href='date/2006/06.html'>June 2006</a></li>
	<li><a href='date/2006/05.html'>May 2006</a></li>
	<li><a href='date/2006/04.html'>April 2006</a></li>
	<li><a href='date/2006/03.html'>March 2006</a></li>
	<li><a href='date/2006/02.html'>February 2006</a></li>
	<li><a href='date/2006/01.html'>January 2006</a></li>
        </ul>
      </li>

      <li><h2>Categories</h2>
        <ul>
        	<li class="cat-item cat-item-1"><a href="category/agile.html" >Agile</a> (229)
</li>
	<li class="cat-item cat-item-3"><a href="category/books.html" >Books</a> (2)
</li>
	<li class="cat-item cat-item-11"><a href="category/design-exercise.html" >Design Exercise</a> (5)
</li>
	<li class="cat-item cat-item-6"><a href="category/essay.html" >Essay</a> (13)
</li>
	<li class="cat-item cat-item-8"><a href="category/expressive-code.html" >Expressive Code</a> (11)
</li>
	<li class="cat-item cat-item-10"><a href="category/fundamentals.html" >Fundamentals</a> (6)
</li>
	<li class="cat-item cat-item-9"><a href="category/other.html" >other</a> (1)
</li>
        </ul>
      </li>

      
    </ul>
  </div>

    </div>
</div>


<hr />
<div id="footer">
<address>
  <script type="text/javascript">eval(unescape('%64%6f%63%75%6d%65%6e%74%2e%77%72%69%74%65%28%27%3c%61%20%68%72%65%66%3d%22%6d%61%69%6c%74%6f%3a%76%61%63%63%61%72%69%40%70%6f%62%6f%78%2e%63%6f%6d%22%3e%76%61%63%63%61%72%69%40%70%6f%62%6f%78%2e%63%6f%6d%3c%2f%61%3e%27%29%3b'))</script>
</address>
</div>
</div>
  <script type='text/javascript' src='../wp-includes/js/wp-embed.min3c21.js?ver=5.1.1'></script>
<script async="async" type='text/javascript' src='../wp-content/plugins/akismet/_inc/form0235.js?ver=4.1.1'></script>
</body>

<!-- Mirrored from matteo.vaccari.name/blog/archives/650 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 24 Sep 2021 09:57:49 GMT -->
</html>
