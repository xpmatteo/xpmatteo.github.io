<!DOCTYPE html>
<html>


<!-- Mirrored from matteo.vaccari.name/blog/archives/824 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 24 Sep 2021 10:25:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="initial-scale=1">

<title>Extreme Enthusiasm  &raquo; Blog Archive   &raquo; Refactor to remove duplication</title>

<meta name="generator" content="WordPress 5.1.1" /> <!-- leave this for stats -->

<link rel="stylesheet" href="../wp-content/themes/mv2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Extreme Enthusiasm RSS Feed" href="../feed" />
<link rel="pingback" href="../xmlrpc.php" />

<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="Extreme Enthusiasm &raquo; Refactor to remove duplication Comments Feed" href="824/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11.2.0\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/matteo.vaccari.name\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.1.1"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='../wp-includes/css/dist/block-library/style.min3c21.css?ver=5.1.1' type='text/css' media='all' />
<link rel='https://api.w.org/' href='../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Another personal update' href='820.html' />
<link rel='next' title='Doing the job of the customer?' href='833.html' />
<meta name="generator" content="WordPress 5.1.1" />
<link rel="canonical" href="824.html" />
<link rel='shortlink' href='../indexa3d8.html?p=824' />
<link rel="alternate" type="application/json+oembed" href="../wp-json/oembed/1.0/embedb651.json?url=http%3A%2F%2Fmatteo.vaccari.name%2Fblog%2Farchives%2F824" />
<link rel="alternate" type="text/xml+oembed" href="../wp-json/oembed/1.0/embed314b?url=http%3A%2F%2Fmatteo.vaccari.name%2Fblog%2Farchives%2F824&amp;format=xml" />
</head>
<body>
<div id="page">

<div id="header">
	<h1><a href="../../blog">Extreme Enthusiasm</a></h1>
</div>

<div id='maincontent'>
    <div id='main-col'>

  
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="820.html" rel="prev">Another personal update</a></div>
			<div class="alignright"><a href="833.html" rel="next">Doing the job of the customer?</a> &raquo;</div>
		</div>

		<div class="post" id="post-824">
			<h2><a href="824.html" rel="bookmark" title="Permanent Link: Refactor to remove duplication">Refactor to remove duplication</a></h2>

			<div class="entrytext">
				<p>The gist of the message I got from Extreme Programming in the early years of this century was that good code would just emerge if we followed the four rules of Simple Design, as advocated by Kent Beck:</p>
<blockquote><p>
The code is simple enough when it:</p>
<ol>
<li>Runs all the tests</li>
<li>Has no duplicated logic</li>
<li>States every intention important to the programmers</li>
<li>Has the fewest possible classes and methods</li>
</ol>
<p>in this order.
</p></blockquote>
<p>Various formulation of this list exist.  Given that &#8220;Runs all the test&#8221; is granted (we don&#8217;t want broken code) and &#8220;Has the fewest possible classes and methods&#8221; is also granted (simplicity seems to imply &#8220;few things&#8221;), I often wondered how the other two rules can be used to generate good design.  </p>
<p>J.B. Rainsberger <a href="http://www.jbrains.ca/permalink/the-four-elements-of-simple-design">says</a>:</p>
<blockquote><p>
  Put more simply, if you master removing duplication and fixing bad names, then I claim you master object-oriented design
</p></blockquote>
<p>That&#8217;s a bold claim! How can this be?</p>
<p>In TDD By Example, Kent Beck says that the third step of TDD is not just &#8220;refactor&#8221;, but <strong>refactor to remove duplication</strong>.  The point then is &#8220;what is duplication?&#8221;  Is that just duplicated lines of code?  </p>
<p>Over time I started collecting interesting examples of duplication.  It turns out that <em>seeing duplication</em> is a skill that has to be learned.</p>
<h3>Obvious duplication</h3>
<p>The most obvious form of duplication is duplicated lines of code.  That is usually cured by extracting the common lines in a method.  The extraction of a method is often followed by moving the method to a new class, or another existing class.</p>
<p>This is just one way the four rules push towards a better design.  There are others.</p>
<h3>Duplication in names</h3>
<p>There is a beautiful simple exercise in chapter 1 of <a href="http://www2.cpttm.org.mo/cyberlab/softdev/ESAD/">Essential Skills for Agile Development</a>.  It asks to remove duplication in code that looks like this one:</p>
<p><code></p>
<pre>
class Organization {
  String primaryContactFirstName;
  String primaryContactLastName;
  String primaryContactPhone;
  String secondaryContactFirstName;
  String secondaryContactLastName;
  String secondaryContactPhone;
  ...
}    
</pre>
<p></code></p>
<p>There is no &#8220;code&#8221; here, just data declarations.  There is quite obvious duplication in the names though.  The string &#8220;primaryContact&#8221; is repeated three times.  The sequence &#8220;firstName, lastName, phone&#8221; is repeated two times.  The point is to arrive at something like</p>
<p><code></p>
<pre>
class Organization {
  Contact primaryContact;
  Contact secondaryContact;
  ...
}    
</pre>
<p></code></p>
<h3>Primitive obsession</h3>
<p><em>Primitive Obsession</em> is one of the classic smells from the Refactoring book.  It happens when we use primitive types in place of our own types.  You can see it in the Organization example above, where we use a String to represent a phone number, and again String to represent names of persons.</p>
<p>Primitive Obsession is one of the most common smells.  Most developers are not even aware that it is a problem.  It is also a smell that takes a long time to remove.  And &#8230; it is a form of duplication.  We are <em>duplicating the choice of representation</em> for a concept.  We can see the cost of this choice when we decide that, say, we want to stop using Java native Date type and start using the Joda Time replacement; then it takes ages to convert all of our code to the new type.</p>
<p>But when we do this replacement, we are still falling in the same trap; if we change our mind again, it will again take a very long time to convert the code.  What is the answer to this problem?  Should we think long and hard before we start our project on which Date class we want to use, to minimize the chance of having to change it later?  Would that work?</p>
<p>Of course not! What we really want is to be able to change our mind quickly, whenever we learn that our first choice was not adequate.  Again, the key is in removing the duplication: make the choice in a single place; all of our code will use our own XDate class.  Our XDate could use java.util.Date internally, or something else, but code outside XDate does not know and does not care.</p>
<p>(Aside.  Using our own Date type has the beneficial effect that all the static method that are usually found in a number of DateUtils classes become instance methods in XDate.  Another smell is removed!  End Aside.)</p>
<h3>Using third party APIs directly</h3>
<p>The primitive obsession smell is just an example of a more general problem: when we use someone else&#8217;s API, we use it directly throughout our code.  When we need, say, to download a data file from some service, what do we do?  Do we start littering our code with calls to java.net.URL and java.net.HttpUrlConnection?  Heavens, no!  That would be committing ourselves to a particular way to solve the http connection problem, and duplicating it in all the places where we need to do it.  </p>
<p>That would also be a violation of what Robert Martin calls the &#8220;Dependency Inversion Principle&#8221;: depend on abstractions, not on concretions.  The java.net.URL is a concrete way to solve the &#8220;download a remote file&#8221; problem.  </p>
<p>A better solution would be to hide the decision inside a class.  Just define a <samp>RemoteFile</samp> class with a <samp>download</samp> method.  This way we avoid duplication.</p>
<p>Alas, this is another smell that most developers don&#8217;t even know about.</p>
<h3>Hiding design decisions</h3>
<p>This brings us to a connection that was not obvious: removing duplication leads to the famous paper by David Parnas <a href="https://www.google.com/search?q=on+the+criteria+to+be+used+in+decomposing+systems+into+modules">On the criteria to be used in decomposing systems into modules</a>.  Quote:</p>
<blockquote><p>
  We propose instead that one begins with a list of difficult design decisions or design decisions which are likely to change. Each module is then designed to hide such a decision from the others. Since, in most cases, design decisions transcend time of execution, modules will not correspond to steps in the processing.
</p></blockquote>
<p>There you have it: a class is a way to codify and centralize a design decision.  A design decision that is duplicated should be moved to its proper home in a single place.  This is one of the things that an XPer must learn, in order to become effective at <a href="http://blog.nayima.be/2012/11/04/agile-tour-brussels-2012-presentation/">becoming faster than the customer</a> :-)</p>
<p>Further reading: an <a href="http://www.jamesshore.com/Blog/DrawingTheLineOnContinuousDesign.html">essay by James Shore</a> on why removing duplication is key to making continuous design work: it mitigates the risk that unforeseen circumstances will force us to change an earlier decision.</p>

				
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on 17 March 2013 at 18:59						and is filed under <a href="category/agile.html" rel="category tag">Agile</a>.
						You can follow any responses to this entry through the <a href="824/feed">RSS 2.0</a> feed.

													You can <a href="#respond">leave a response</a>, or <a href="824/trackback" rel="trackback">trackback</a> from your own site.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->

	<h3 id="comments">2 Responses to &#8220;Refactor to remove duplication&#8221;</h3> 

	<ol class="commentlist">

	
		<li class="alt" id="comment-95863">
			<cite><a href='http://twitter.com/siriquelle' rel='external nofollow' class='url'>Siriquelle</a></cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-95863" title="">March 22nd, 2013 at 10:39</a> </small>

			<p>I am defiantly guilty of some of the code smells you have eluded to, especially primitive obsession. Thoroughly enjoyable writing too I might add.</p>

		</li>

	
	
		<li class="" id="comment-95885">
			<cite><a href='http://www.voronoigame.com/' rel='external nofollow' class='url'>Indrit</a></cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-95885" title="">March 27th, 2013 at 14:56</a> </small>

			<p>When I switched from Java to Ruby I had a lot of problems when sharing these concepts with almost all my ruby colleagues in the USA. It seemed like in &#8220;ruby&#8221; the laws of software development were different&#8230;and then I discovered that the code base was much more like a &#8220;horror crime scene&#8221; than an &#8220;agile&#8221; organization. These concepts has universal value and should be taken seriously. This doesn&#8217;t mean that one should have a cut-and-paste approach and become a &#8220;victim&#8221; of the same but every case should be pragmatically evaluated in base of the &#8216;likelyhood of change&#8217;.</p>

		</li>

	
	
	</ol>

 


<h3 id="respond">Leave a Reply</h3>


<form action="http://matteo.vaccari.name/blog/wp-comments-post.php" method="post" id="commentform">


<p><input type="text" name="author" id="author" value="" size="22" tabindex="1" />
<label for="author"><small>Name (required)</small></label></p>

<p><input type="text" name="email" id="email" value="" size="22" tabindex="2" />
<label for="email"><small>Mail (will not be published) (required)</small></label></p>

<p><input type="text" name="url" id="url" value="" size="22" tabindex="3" />
<label for="url"><small>Website</small></label></p>


<!--<p><small><strong>XHTML:</strong> You can use these tags: &lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;s&gt; &lt;strike&gt; &lt;strong&gt; </small></p>-->

<p><textarea name="comment" id="comment" cols="100%" rows="10" tabindex="4"></textarea></p>

<p><input name="submit" type="submit" id="submit" tabindex="5" value="Submit Comment" />
<input type="hidden" name="comment_post_ID" value="824" />
</p>
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="6b6bcb3c34" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="102"/></p>
</form>



	
    </div>

    <div id='right-col'>
        <div id="sidebar">
    <ul>

      <li>
        <form method="get" id="searchform" action="http://matteo.vaccari.name/blog/">
  <div>
    <input tabindex="1" type="text" value="" name="s" id="s" />
    <input type="submit" id="searchsubmit" value="Search" />
  </div>
</form>
      </li>

      <li>

        <h2>About</h2>

	I am a software developer working with <a href="http://thoughtworks.com/">Thoughtworks Italia</a>.
        I'm a fan of <a
        href="http://extremeprogramming.org/">Extreme Programming</a>.
        I&nbsp;helped organize the <a
        href="http://essap.dicom.uninsubria.it/">European Summer School on
        Agile Programming</a>

      </li>

      <li>
            </li>

      <li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-851"><a href="../selected-tdd-resources-to-start.html">Selected TDD Resources To Start</a></li>
<li class="page_item page-item-583"><a href="../tdd-resources.html">TDD Resources</a></li>
<li class="page_item page-item-247"><a href="../the-hexagonal-architecture.html">The Hexagonal Architecture</a></li>
</ul></li>

      
      <li><h2>Archives</h2>
        <ul>
        	<li><a href='date/2018/10.html'>October 2018</a></li>
	<li><a href='date/2017/09.html'>September 2017</a></li>
	<li><a href='date/2016/08.html'>August 2016</a></li>
	<li><a href='date/2016/03.html'>March 2016</a></li>
	<li><a href='date/2016/01.html'>January 2016</a></li>
	<li><a href='date/2014/12.html'>December 2014</a></li>
	<li><a href='date/2014/10.html'>October 2014</a></li>
	<li><a href='date/2014/06.html'>June 2014</a></li>
	<li><a href='date/2014/02.html'>February 2014</a></li>
	<li><a href='date/2013/12.html'>December 2013</a></li>
	<li><a href='date/2013/11.html'>November 2013</a></li>
	<li><a href='date/2013/06.html'>June 2013</a></li>
	<li><a href='date/2013/05.html'>May 2013</a></li>
	<li><a href='date/2013/03.html'>March 2013</a></li>
	<li><a href='date/2013/02.html'>February 2013</a></li>
	<li><a href='date/2012/10.html'>October 2012</a></li>
	<li><a href='date/2012/08.html'>August 2012</a></li>
	<li><a href='date/2012/07.html'>July 2012</a></li>
	<li><a href='date/2012/06.html'>June 2012</a></li>
	<li><a href='date/2012/05.html'>May 2012</a></li>
	<li><a href='date/2012/04.html'>April 2012</a></li>
	<li><a href='date/2012/01.html'>January 2012</a></li>
	<li><a href='date/2011/12.html'>December 2011</a></li>
	<li><a href='date/2011/11.html'>November 2011</a></li>
	<li><a href='date/2011/10.html'>October 2011</a></li>
	<li><a href='date/2011/07.html'>July 2011</a></li>
	<li><a href='date/2011/06.html'>June 2011</a></li>
	<li><a href='date/2011/05.html'>May 2011</a></li>
	<li><a href='date/2011/04.html'>April 2011</a></li>
	<li><a href='date/2011/03.html'>March 2011</a></li>
	<li><a href='date/2011/02.html'>February 2011</a></li>
	<li><a href='date/2010/11.html'>November 2010</a></li>
	<li><a href='date/2010/10.html'>October 2010</a></li>
	<li><a href='date/2010/09.html'>September 2010</a></li>
	<li><a href='date/2010/08.html'>August 2010</a></li>
	<li><a href='date/2010/07.html'>July 2010</a></li>
	<li><a href='date/2010/06.html'>June 2010</a></li>
	<li><a href='date/2010/05.html'>May 2010</a></li>
	<li><a href='date/2010/04.html'>April 2010</a></li>
	<li><a href='date/2010/03.html'>March 2010</a></li>
	<li><a href='date/2010/02.html'>February 2010</a></li>
	<li><a href='date/2010/01.html'>January 2010</a></li>
	<li><a href='date/2009/12.html'>December 2009</a></li>
	<li><a href='date/2009/11.html'>November 2009</a></li>
	<li><a href='date/2009/10.html'>October 2009</a></li>
	<li><a href='date/2009/09.html'>September 2009</a></li>
	<li><a href='date/2009/07.html'>July 2009</a></li>
	<li><a href='date/2009/05.html'>May 2009</a></li>
	<li><a href='date/2009/04.html'>April 2009</a></li>
	<li><a href='date/2009/03.html'>March 2009</a></li>
	<li><a href='date/2009/02.html'>February 2009</a></li>
	<li><a href='date/2009/01.html'>January 2009</a></li>
	<li><a href='date/2008/12.html'>December 2008</a></li>
	<li><a href='date/2008/11.html'>November 2008</a></li>
	<li><a href='date/2008/10.html'>October 2008</a></li>
	<li><a href='date/2008/09.html'>September 2008</a></li>
	<li><a href='date/2008/07.html'>July 2008</a></li>
	<li><a href='date/2008/06.html'>June 2008</a></li>
	<li><a href='date/2008/05.html'>May 2008</a></li>
	<li><a href='date/2008/04.html'>April 2008</a></li>
	<li><a href='date/2008/01.html'>January 2008</a></li>
	<li><a href='date/2007/11.html'>November 2007</a></li>
	<li><a href='date/2007/10.html'>October 2007</a></li>
	<li><a href='date/2007/09.html'>September 2007</a></li>
	<li><a href='date/2007/06.html'>June 2007</a></li>
	<li><a href='date/2007/05.html'>May 2007</a></li>
	<li><a href='date/2007/04.html'>April 2007</a></li>
	<li><a href='date/2007/03.html'>March 2007</a></li>
	<li><a href='date/2007/02.html'>February 2007</a></li>
	<li><a href='date/2007/01.html'>January 2007</a></li>
	<li><a href='date/2006/12.html'>December 2006</a></li>
	<li><a href='date/2006/11.html'>November 2006</a></li>
	<li><a href='date/2006/10.html'>October 2006</a></li>
	<li><a href='date/2006/09.html'>September 2006</a></li>
	<li><a href='date/2006/08.html'>August 2006</a></li>
	<li><a href='date/2006/07.html'>July 2006</a></li>
	<li><a href='date/2006/06.html'>June 2006</a></li>
	<li><a href='date/2006/05.html'>May 2006</a></li>
	<li><a href='date/2006/04.html'>April 2006</a></li>
	<li><a href='date/2006/03.html'>March 2006</a></li>
	<li><a href='date/2006/02.html'>February 2006</a></li>
	<li><a href='date/2006/01.html'>January 2006</a></li>
        </ul>
      </li>

      <li><h2>Categories</h2>
        <ul>
        	<li class="cat-item cat-item-1"><a href="category/agile.html" >Agile</a> (229)
</li>
	<li class="cat-item cat-item-3"><a href="category/books.html" >Books</a> (2)
</li>
	<li class="cat-item cat-item-11"><a href="category/design-exercise.html" >Design Exercise</a> (5)
</li>
	<li class="cat-item cat-item-6"><a href="category/essay.html" >Essay</a> (13)
</li>
	<li class="cat-item cat-item-8"><a href="category/expressive-code.html" >Expressive Code</a> (11)
</li>
	<li class="cat-item cat-item-10"><a href="category/fundamentals.html" >Fundamentals</a> (6)
</li>
	<li class="cat-item cat-item-9"><a href="category/other.html" >other</a> (1)
</li>
        </ul>
      </li>

      
    </ul>
  </div>

    </div>
</div>


<hr />
<div id="footer">
<address>
  <script type="text/javascript">eval(unescape('%64%6f%63%75%6d%65%6e%74%2e%77%72%69%74%65%28%27%3c%61%20%68%72%65%66%3d%22%6d%61%69%6c%74%6f%3a%76%61%63%63%61%72%69%40%70%6f%62%6f%78%2e%63%6f%6d%22%3e%76%61%63%63%61%72%69%40%70%6f%62%6f%78%2e%63%6f%6d%3c%2f%61%3e%27%29%3b'))</script>
</address>
</div>
</div>
  <script type='text/javascript' src='../wp-includes/js/wp-embed.min3c21.js?ver=5.1.1'></script>
<script async="async" type='text/javascript' src='../wp-content/plugins/akismet/_inc/form0235.js?ver=4.1.1'></script>
</body>

<!-- Mirrored from matteo.vaccari.name/blog/archives/824 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 24 Sep 2021 10:25:24 GMT -->
</html>
